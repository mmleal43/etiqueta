<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ALDISAN-KSK – REPORTE DE EMBARQUE (Tarimas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0c0f1f">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Librerías desde CDN (cacheadas por Service Worker tras primer uso) -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <style>
    :root{
      --c1:#00e5ff;
      --bg:#0c0f1f;
      --panel:#151a2b;
      --muted:#93a4b8;
      --paper-w:21.59cm;  /* Carta */
      --paper-h:27.94cm;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 50% -200px,#16304a 10%, var(--bg) 60%, #090c17 100%);
      color:#e6eef7;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header h1{
      margin:0 0 8px;
      font-weight:800; letter-spacing:.3px;
      color:var(--c1); text-shadow:0 0 8px rgba(0,229,255,.35);
      font-size:clamp(20px,4vw,32px);
      text-align:center;
    }
    header p{margin:0;text-align:center;color:var(--muted)}

    .grid{
      display:grid; gap:16px; margin-top:16px;
      grid-template-columns: 1.1fr 1fr;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px; font-size:18px; color:#fff; letter-spacing:.3px
    }

    /* Panel escáner */
    #reader{
      width:100%; min-height:320px; background:#0b1220; border-radius:12px;
      border:1px solid rgba(255,255,255,.08); overflow:hidden; position:relative;
    }
    .scan-flash{position:absolute; inset:0; pointer-events:none; background:rgba(0,255,170,.15);
      box-shadow: inset 0 0 0 2px rgba(0,255,170,.4);
      opacity:0; transform:scale(1.02); transition:opacity .15s ease, transform .25s ease}
    .scan-flash.show{opacity:1; transform:scale(1)}
    .idle-overlay{
      position:absolute; inset:0; display:none; place-items:center; text-align:center;
      background:rgba(2,8,23,.85); padding:24px;
    }
    .idle-overlay.active{display:grid}
    .idle-overlay button{
      margin-top:10px; padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:#0f1b2e; color:#fff; cursor:pointer
    }

    /* Datos y acciones */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    label{font-size:12px; color:var(--muted); margin-bottom:4px; display:block}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:#0f172a; color:#e6eef7; outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--c1); box-shadow:0 0 0 3px rgba(0,229,255,.15)}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    button, .ghost{
      appearance:none; border:none; border-radius:12px; padding:10px 14px; cursor:pointer;
      background:#0f2438; color:#fff; border:1px solid rgba(255,255,255,.12);
    }
    .primary{background:linear-gradient(90deg, #00e5ff, #36d1dc); color:#00131a; border:none; font-weight:700}
    .success{background:linear-gradient(90deg, #00d26a, #23e0a5); color:#001a0d; font-weight:700}
    .danger{background:linear-gradient(90deg, #ff7373, #ff4d4d); color:#2a0000; font-weight:700}
    .muted{opacity:.85}

    .stats{display:flex; gap:14px; margin-top:10px; color:#cfe6ff}
    .stats span{background:#0f172a; border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:12px}

    table{
      width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; background:#0d1526;
      border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden
    }
    th, td{border-bottom:1px solid rgba(255,255,255,.06); padding:8px 10px; text-align:left}
    th{color:#a9c8ff; background:rgba(255,255,255,.04); font-weight:600}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .td-actions button{padding:6px 10px; font-size:12px}

    .qr-block{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    #qrCarga{width:140px; height:140px; background:#fff; border-radius:8px; padding:6px}

    footer{margin:18px 0 8px; text-align:center; color:var(--muted); font-size:12px}

    /* ======= VISTA DE IMPRESIÓN (Carta) ======= */
    @media print{
      body{background:white; color:black}
      .wrap{max-width:none; padding:0}
      .grid, header p, .actions, #reader, .card:not(.print-only){display:none !important}
      #printable{display:block !important}
    }
    #printable{
      display:none; background:white; color:#000; width:var(--paper-w);
      min-height:var(--paper-h); margin:0 auto; padding:1.2cm;
      font-size:12pt; line-height:1.2;
    }
    #printable h1{margin:0 0 6px; font-size:18pt; color:#000}
    #printable .meta{display:grid; grid-template-columns:1.5fr .8fr .8fr; gap:.5cm; margin:.4cm 0 .3cm}
    #printable .meta div{border:1px solid #000; padding:.35cm; border-radius:6px}
    #printable .qr-and-only{display:grid; grid-template-columns:3cm 1fr; gap:.6cm; align-items:start}
    #printable #qrCargaPrint{width:3cm; height:3cm; border:1px solid #000; padding:.2cm}
    #printable table{width:100%; border-collapse:collapse; margin-top:.5cm; font-size:11pt}
    #printable th, #printable td{border:1px solid #000; padding:.2cm; text-align:left}
    #printable .firmas{display:grid; grid-template-columns:1fr 1fr; gap:1cm; margin-top:1cm}
    #printable .firma{height:2.5cm; border-top:1px solid #000; text-align:center; padding-top:.2cm}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <p>Escanea los QR de las tarimas. Guarda, imprime o exporta a Excel. La cámara se pausa sola tras 20 s sin uso.</p>
    </header>

    <div class="grid">
      <!-- Panel escáner -->
      <section class="card">
        <h2>1) Escáner QR</h2>
        <div id="reader">
          <div class="scan-flash" id="scanFlash"></div>
          <div class="idle-overlay" id="idleOverlay">
            <div>
              <div style="font-weight:700; font-size:18px">Cámara pausada por inactividad</div>
              <div class="muted">Toca “Reactivar cámara” para continuar</div>
              <button id="btnResume">Reactivar cámara</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="btnStart" class="primary">Iniciar cámara</button>
          <button id="btnStop" class="ghost" disabled>Detener cámara</button>
          <select id="cameraSelect" title="Cámara" class="muted"></select>
        </div>
        <div class="stats">
          <span>Total escaneos: <b id="totalCount">0</b></span>
          <span>Cámara: <b id="camStatus">Detenida</b></span>
        </div>
      </section>

      <!-- Datos y QR de embarque -->
      <section class="card">
        <h2>2) Datos de embarque</h2>
        <div class="row">
          <div>
            <label>Operador</label>
            <input id="inpOperador" placeholder="Nombre del operador">
          </div>
          <div>
            <label>Placas</label>
            <input id="inpPlacas" placeholder="ABC-123-X">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Tipo de unidad</label>
            <select id="selUnidad">
              <option value="Camioneta">Camioneta</option>
              <option value="Tráiler">Tráiler</option>
              <option value="Torton">Torton</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div>
            <label>Factura / Pedimento</label>
            <input id="inpFactura" placeholder="Factura o Pedimento">
          </div>
        </div>

        <div style="margin-top:12px" class="qr-block">
          <div>
            <div style="font-size:12px; color:var(--muted); margin-bottom:6px">QR del embarque (se imprime)</div>
            <div id="qrCarga"></div>
          </div>
          <div class="muted" style="max-width:420px">
            Este QR codifica los datos del embarque (operador, placas, unidad, factura/pedimento y todas las tarimas).  
            Se incrusta en la impresión automáticamente.
          </div>
        </div>

        <div class="actions">
          <button class="success" id="btnExportXLSX">Exportar Excel</button>
          <button class="primary" id="btnPrint">Imprimir / Guardar PDF</button>
          <button class="danger" id="btnClear">Borrar todo</button>
        </div>
      </section>
    </div>

    <!-- Lista de escaneos -->
    <section class="card" style="margin-top:16px">
      <h2>3) Tarimas escaneadas</h2>
      <table>
        <thead>
          <tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th><th class="td-actions">Acciones</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Vista de impresión (sin “Notas”, solo QR) -->
    <section id="printable" class="print-only">
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <div class="meta">
        <div>
          <b>Operador:</b> <span id="pOperador"></span><br>
          <b>Placas:</b> <span id="pPlacas"></span><br>
          <b>Tipo de unidad:</b> <span id="pUnidad"></span><br>
          <b>Factura/Pedimento:</b> <span id="pFactura"></span><br>
          <b>Fecha reporte:</b> <span id="pFecha"></span>
        </div>
        <div>
          <b>Total tarimas escaneadas:</b> <span id="pTotal"></span><br>
          <b>Código de embarque:</b> <span id="pCodigo"></span>
        </div>
        <!-- Solo QR al imprimir -->
        <div class="qr-and-only">
          <div id="qrCargaPrint"></div>
          <div></div>
        </div>
      </div>
      <table>
        <thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead>
        <tbody id="pTbody"></tbody>
      </table>
      <div class="firmas">
        <div class="firma">OPERADOR</div>
        <div class="firma">VÍCTOR GONZÁLES</div>
      </div>
    </section>

    <footer>© ALDISAN-KSK · Herramienta local de reporte de tarimas</footer>
  </div>

  <script>
  // ====== SW register ======
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  }

  // ====== UTILIDADES ======
  const $ = (s, root=document)=>root.querySelector(s);
  const $$ = (s, root=document)=>Array.from(root.querySelectorAll(s));
  const formatDateTime = d => {
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

  // Beep con WebAudio (sin archivos externos)
  const beep = (() => {
    let ctx; 
    return (ms=120, freq=880) => {
      try{
        ctx = ctx || new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square'; o.frequency.value = freq;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.03, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + ms/1000);
        o.start(); o.stop(ctx.currentTime + ms/1000);
      }catch(e){}
    };
  })();

  // ====== ESTADO ======
  const state = {
    scans: [], // {id, text, ts}
    form: { operador:"", placas:"", unidad:"Camioneta", factura:"" },
    lastScanText:null, lastScanAt:0
  };
  const LS_KEY = "reporteTarimas_v1";

  function saveLS(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    renderStats();
    refreshQR();
  }
  function loadLS(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      if(s.scans) state.scans = s.scans;
      if(s.form) state.form = Object.assign(state.form, s.form);
    }catch(e){}
  }

  // ====== RENDER ======
  function renderForm(){
    $("#inpOperador").value = state.form.operador;
    $("#inpPlacas").value = state.form.placas;
    $("#selUnidad").value = state.form.unidad;
    $("#inpFactura").value = state.form.factura;
  }
  function renderStats(){
    $("#totalCount").textContent = state.scans.length;
  }
  function renderTable(){
    const tbody = $("#tbody"); tbody.innerHTML = "";
    state.scans.forEach((s, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td style="word-break:break-word">${s.text}</td>
        <td>${formatDateTime(new Date(s.ts))}</td>
        <td class="td-actions">
          <button data-id="${s.id}" class="ghost danger small btnDel">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    // Borrar item
    $$(".btnDel").forEach(b=>{
      b.onclick = (e)=>{
        const id = e.currentTarget.getAttribute("data-id");
        state.scans = state.scans.filter(x=>x.id!==id);
        saveLS(); renderTable();
      }
    });
  }

  // ====== QR DE EMBARQUE ======
  let qrWidget=null, qrWidgetPrint=null;
  function getPayload(){
    return {
      meta:{
        version:1,
        generatedAt: new Date().toISOString(),
      },
      operador: state.form.operador||"",
      placas: state.form.placas||"",
      unidad: state.form.unidad||"",
      factura: state.form.factura||"",
      total: state.scans.length,
      items: state.scans.map(s=>({text:s.text, ts:s.ts}))
    };
  }
  function refreshQR(){
    const txt = JSON.stringify(getPayload());
    // QR visible en pantalla
    const el = $("#qrCarga"); el.innerHTML = "";
    qrWidget = new QRCode(el, {text: txt, width:140, height:140, correctLevel: QRCode.CorrectLevel.M});
    // QR para impresión (se clona de nuevo cada vez para asegurar nitidez)
    const elp = $("#qrCargaPrint"); elp.innerHTML = "";
    qrWidgetPrint = new QRCode(elp, {text: txt, width:150, height:150, correctLevel: QRCode.CorrectLevel.M});
  }

  // ====== IMPRESIÓN ======
  function preparePrintView(){
    $("#pOperador").textContent = state.form.operador||"—";
    $("#pPlacas").textContent = state.form.placas||"—";
    $("#pUnidad").textContent = state.form.unidad||"—";
    $("#pFactura").textContent = state.form.factura||"—";
    $("#pFecha").textContent = formatDateTime(new Date());
    $("#pTotal").textContent = state.scans.length;
    $("#pCodigo").textContent = (state.form.operador||"-").slice(0,3).toUpperCase() + "-" + (state.form.placas||"---");
    const tbody = $("#pTbody"); tbody.innerHTML="";
    state.scans.forEach((s,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${s.text}</td><td>${formatDateTime(new Date(s.ts))}</td>`;
      tbody.appendChild(tr);
    });
    // Asegurar QR de impresión actualizado
    refreshQR();
  }

  // ====== EXCEL ======
  function exportXLSX(){
    const data = [
      ["ALDISAN-KSK REPORTE DE EMBARQUE"],
      ["Operador", state.form.operador],
      ["Placas", state.form.placas],
      ["Tipo de unidad", state.form.unidad],
      ["Factura/Pedimento", state.form.factura],
      ["Fecha de exportación", formatDateTime(new Date())],
      [],
      ["#", "Contenido QR", "Fecha/Hora"]
    ];
    state.scans.forEach((s,i)=> data.push([i+1, s.text, formatDateTime(new Date(s.ts))]));
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Embarque");
    XLSX.writeFile(wb, "reporte_embarque.xlsx");
  }

  // ====== ESCÁNER ======
  let html5Scanner = null;
  let lastActivityAt = Date.now();
  let idleTimer = null;
  const IDLE_MS = 20000;
  const $overlay = $("#idleOverlay");
  const $flash = $("#scanFlash");
  const $camStatus = $("#camStatus");

  async function listCameras(){
    try{
      const devices = await Html5Qrcode.getCameras();
      const sel = $("#cameraSelect"); sel.innerHTML = "";
      devices.forEach((d,i)=>{
        const opt = document.createElement("option");
        opt.value = d.id; opt.textContent = d.label || `Cámara ${i+1}`;
        sel.appendChild(opt);
      });
    }catch(e){
      // no-op
    }
  }

  function startIdleWatch(){
    stopIdleWatch();
    idleTimer = setInterval(()=>{
      if(!html5Scanner) return;
      if(Date.now() - lastActivityAt > IDLE_MS){
        pauseCameraForIdle();
      }
    }, 1000);
  }
  function stopIdleWatch(){ if(idleTimer){ clearInterval(idleTimer); idleTimer=null; } }

  async function startCamera(){
    if(html5Scanner){ try{ await html5Scanner.stop(); }catch(e){} html5Scanner=null; }
    const camId = $("#cameraSelect").value || { facingMode: { exact: "environment" } };
    html5Scanner = new Html5Qrcode("reader", {verbose:false});
    const config = { fps: 10, qrbox: { width: 260, height: 260 }, rememberLastUsedCamera: true, aspectRatio: 1.333 };
    $camStatus.textContent = "Iniciando…";
    try{
      await html5Scanner.start(
        camId,
        config,
        qrText => {
          // Permitir re-escanear el mismo código (antirrebote 1.2s)
          const now = Date.now();
          if (qrText === state.lastScanText && (now - state.lastScanAt) < 1200) {
            lastActivityAt = now;
            return;
          }
          state.lastScanText = qrText; state.lastScanAt = now;
          lastActivityAt = now;

          // Animación, sonido y vibración
          $flash.classList.add("show");
          setTimeout(()=> $flash.classList.remove("show"), 160);
          beep(100, 1200);
          if(navigator.vibrate) navigator.vibrate(80);

          // Registrar escaneo (sin deduplicar)
          state.scans.push({id:uid(), text:qrText, ts:new Date().toISOString()});
          saveLS(); renderTable();
        },
        err => {
          // errores de decodificación: ignorar
        }
      );
      $camStatus.textContent = "Activa";
      $("#btnStart").disabled = true;
      $("#btnStop").disabled = false;
      $("#idleOverlay").classList.remove("active");
      lastActivityAt = Date.now();
      startIdleWatch();
    }catch(e){
      alert("No se pudo iniciar la cámara. Revisa permisos del navegador.");
      $camStatus.textContent = "Error";
    }
  }

  async function stopCamera(){
    stopIdleWatch();
    if(html5Scanner){
      try{ await html5Scanner.stop(); }catch(e){}
      try{ await html5Scanner.clear(); }catch(e){}
      html5Scanner = null;
    }
    $("#btnStart").disabled = false;
    $("#btnStop").disabled = true;
    $camStatus.textContent = "Detenida";
  }

  async function pauseCameraForIdle(){
    stopIdleWatch();
    if(html5Scanner){
      try{ await html5Scanner.pause(true); }catch(e){}
      $overlay.classList.add("active");
      $camStatus.textContent = "Pausada";
    }
  }
  async function resumeFromIdle(){
    if(html5Scanner){
      try{ await html5Scanner.resume(); }catch(e){}
      $overlay.classList.remove("active");
      $camStatus.textContent = "Activa";
      lastActivityAt = Date.now();
      startIdleWatch();
    }else{
      startCamera();
    }
  }

  // ====== EVENTOS UI ======
  $("#btnStart").onclick = startCamera;
  $("#btnStop").onclick  = stopCamera;
  $("#btnResume").onclick = resumeFromIdle;
  $("#cameraSelect").onchange = startCamera;

  $("#btnExportXLSX").onclick = exportXLSX;
  $("#btnPrint").onclick = ()=>{
    preparePrintView();
    setTimeout(()=> window.print(), 50);
  };
  $("#btnClear").onclick = ()=>{
    if(confirm("¿Borrar TODO el reporte (datos + tarimas)?")){
      state.scans = [];
      state.form = { operador:"", placas:"", unidad:"Camioneta", factura:"" };
      saveLS(); renderForm(); renderTable(); refreshQR();
    }
  };

  // Guardado en vivo del formulario
  $("#inpOperador").oninput = e=>{ state.form.operador = e.target.value; saveLS(); };
  $("#inpPlacas").oninput = e=>{ state.form.placas = e.target.value; saveLS(); };
  $("#selUnidad").onchange = e=>{ state.form.unidad = e.target.value; saveLS(); };
  $("#inpFactura").oninput = e=>{ state.form.factura = e.target.value; saveLS(); };

  // ====== INIT ======
  (async function init(){
    loadLS();
    renderForm();
    renderStats();
    renderTable();
    refreshQR();
    await listCameras();
    $("#btnStop").disabled = true;

    // Actualización de QR al cambiar el formulario aunque no haya escaneos
    ["inpOperador","inpPlacas","selUnidad","inpFactura"].forEach(id=>{
      document.getElementById(id).addEventListener("change", refreshQR);
    });

    // Marcar actividad por cualquier interacción
    ["click","keydown","touchstart"].forEach(ev=>{
      window.addEventListener(ev, ()=>{ lastActivityAt = Date.now(); }, {passive:true});
    });
  })();
  </script>

</body>
</html>